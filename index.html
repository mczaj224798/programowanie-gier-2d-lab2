<!doctype html>

<html lang="pl">

<head>
    <meta charset="utf-8">
    <title>Canvas</title>
    <meta name="author" content="Maciej Czajkowski">
</head>

<body>
    <canvas id="canvas" width="800" height="600">

    </canvas>

    <script>
        // constants
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 600

        class Ball {
            #ctx;
            x;
            y;
            #radius;
            #color;

            constructor(ctx, x, y, radius, color) {
                this.#ctx = ctx;
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.#color = color;
                this.draw();
            }

            draw() {
                this.#ctx.globalCompositeOperation = 'source-over';
                this.#ctx.beginPath();
                var startAngle = 0; // Starting point on circle
                var endAngle = 2 * Math.PI; // End point on circle
                this.#ctx.arc(this.x, this.y, this.radius, startAngle, endAngle);
                this.#ctx.fillStyle = this.#color;
                this.#ctx.fill();
                this.#ctx.closePath();

            }

            clear() {
                this.#ctx.globalCompositeOperation = 'destination-out';
                this.#ctx.beginPath();
                var startAngle = 0; // Starting point on circle
                var endAngle = 2 * Math.PI; // End point on circle
                this.#ctx.arc(this.x, this.y, this.radius +1 , startAngle, endAngle);
                this.#ctx.fillStyle = this.#color;
                this.#ctx.fill();
                this.#ctx.closePath();
                this.#ctx.globalCompositeOperation = 'source-over';

                
            }

          
        }

        class HitBall extends Ball {
            #interval;
            #hit;
            constructor(ctx, x, y, radius, color, interval, dest) {
                super(ctx, x, y, radius, color);
                this.#interval = interval;
                this.#hit = false;
            }

            setHit() {
                this.#hit = true;
            }

            wasHit() {
                return this.#hit;
            }

            goDown() {
                this.clear();
                this.y += 65;
                this.draw();
            }

        }

        class MovingBall extends Ball {
            #obstacles;
            #ms;
            #interval;

            constructor(ctx, x, y, radius, color, obstacles, ms, dest) {
                super(ctx, x, y, radius, color);
                this.#obstacles = obstacles;
                this.#ms = ms;
                this.#interval = setInterval(() => {
                    if (this.y >= -10) {
                    this.clear();
                    this.y -=10;
                    this.draw();

                    for(let i=0; i<this.#obstacles.length; i++) {
                        if (this.#isHit(this.#obstacles[i]) && this.#obstacles[i].wasHit() == false) {
                            this.#obstacles[i].clear();
                            this.#obstacles[i].setHit();
                            this.draw();
                        }                        
                    }
                }
                }, 100);  
            }
            
            #isHit(ball) {
                if (Math.sqrt(Math.pow(ball.x - this.x, 2) + Math.pow(ball.y - this.y, 2)) <= this.radius + ball.radius) {
                    return true;
                } else {
                    return false;
                }
            }

            getInterval() {
                return this.#interval;
            }
        }
           

        class Pad {
            #ctx;
            #x;
            #y;
            #width;
            #height;
            #color;

            constructor(ctx, x,y, width, height, color) {
                this.#ctx = ctx;
                this.#x = x;
                this.#y = y;
                this.#width = width;
                this.#height = height;
                this.#color = color;
                this.#draw();
            }

            #draw() {
                this.#ctx.fillStyle = this.#color;
                this.#ctx.fillRect(this.#x, this.#y, this.#width, this.#height);
            }

            #clear() {
                this.#ctx.clearRect(this.#x, this.#y, this.#width, this.#height);
            }

            getX() {
                return this.#x + this.#width/2;
            }

            getY() {
                return this.#y + this.#height;
            }

            goLeft() {
                if (this.#x >0 && this.#x < Game.GAME_AREA_WIDTH - this.#width) {
                    this.#clear();
                    this.#x -= 10;
                    this.#draw();
                }
            }

            goRight() {
                if (this.#x >0 && this.#x < Game.GAME_AREA_WIDTH - this.#width - 100) {
                    this.#clear();
                    this.#x += 10;
                    this.#draw();
                }
            }
        }

        class Game {
            #ctx;
            #canvasWidth;
            #canvasHeight

            // pad variables
            static #PAD_WIDTH  = 100;
            static #PAD_HEIGHT = 10;
            #PAD_INIT_X;
            #PAD_INIT_Y;
            #PAD_COLOR = 'rgb(255, 0, 0)';

            static GAME_AREA_WIDTH = 800;
            static GAME_AREA_HEIGHT = 600;

            #balls = [];
            #shootBalls = [];

            pad;
            #shootPossible;
            #counter;

            #intervals = [];

            constructor(canvasId, canvasWidth, canvasHeight) {
                if (canvasHeight < 600 || canvasWidth < 800) {
                    //error
                }
                var canvas = document.getElementById(canvasId);
                if (canvas.getContext) {
                    this.#ctx = canvas.getContext('2d');
                    this.#canvasHeight = canvasHeight;
                    this.#canvasWidth = canvasWidth;
                    this.#PAD_INIT_X = canvasWidth/2 - Game.#PAD_WIDTH/2 -100;
                    this.#PAD_INIT_Y = canvasHeight - Game.#PAD_HEIGHT;
                } else {
                    //error
                }
            }

            init() {
                this.pad = new Pad(this.#ctx, this.#PAD_INIT_X, this.#PAD_INIT_Y, Game.#PAD_WIDTH, Game.#PAD_HEIGHT, 'rgb(0,255,0)');
                this.#counter = 0;
                this.#updateCounter();

                var X = 60 + (this.#canvasWidth-Game.GAME_AREA_WIDTH)/2 ;
                var Y = 30; 

                for(let i=0; i< 8; i++  ) {
                    let ball = new HitBall(this.#ctx, X, Y, 20, 'rgh(255,0,0)', 0, 0);
                    this.#balls.push(ball);
                    X = X + 70;
                }
                this.#addListeners();
                this.#setRunners();
            }

            startGame() {
                this.init();
            }

            #shoot() {
                var ball = new MovingBall(this.#ctx, this.pad.getX(), this.pad.getY() - Game.#PAD_HEIGHT - 15, 15, 'rgb(0,255,0)', this.#balls, 0, 0);
                this.#shootBalls.push(ball); 
            }
            
            #updateCounter() {
                this.#ctx.font = "30px Arial";
                this.#ctx.clearRect(750, 30, 30, 30);
                this.#ctx.fillText(this.#counter, 750, 30);
            }

            #addListeners() {

                // we block shoot spaming
                setInterval(() => {
                    this.#shootPossible = true;
                }, 750 ); 

                window.addEventListener("keydown", e => this.keyListener(e), true) 
            }

            keyListener(e) {
                switch(e.keyCode) {
                        case 37: //left
                            this.pad.goLeft();
                            break;
                        case 39: //right
                            this.pad.goRight();
                            break;
                        case 32: //space
                            if (this.#shootPossible == true) {
                                this.#shootPossible = false;
                                this.#shoot();
                            }
                            break;
                    }
            }

            #setRunners() {
                let interval = setInterval(() => {
                    for(let i=0; i<this.#balls.length; i++) {
                        if (!this.#balls[i].wasHit()) { 
                            this.#balls[i].goDown();    
                        } else {
                            this.#counter++;
                            this.#updateCounter();
                        }
                        if(this.#balls[i].y > 600) {
                            this.#gameOver();
                        }

                        
                    }
                    var X = 60 + (this.#canvasWidth-Game.GAME_AREA_WIDTH)/2 ;
                    var Y = 30; 
                    for(let i=0; i< 8; i++ ) {
                            this.#balls.push(new HitBall(this.#ctx, X, Y, 20, 'rgh(255,0,0)', 0, 0));
                            X = X + 70;
                    }
                    this.#intervals.push(interval);
                }, 2000); 
            }

            #gameOver() {
                console.log("GAME OVER!");

                this.#intervals.forEach(interval => {clearInterval(interval);});
                this.#shootBalls.forEach(ball => {clearInterval(ball.getInterval())});
                // this.#ctx.globalCompositeOperation = 'source-over';
                // this.#ctx.clearRect(0, 0, Game.GAME_AREA_WIDTH, Game.GAME_AREA_HEIGHT)
                // this.#ctx.beginPath();
                this.#ctx.fill();
                this.#ctx.globalCompositeOperation = 'source-over';
                this.#ctx.fillStyle = 'white';
                // this.#ctx.fillRect(0, 0, Game.GAME_AREA_WIDTH, Game.GAME_AREA_HEIGHT);
                this.#ctx.clearRect(0, 0, canvas.width, canvas.height);


                this.#ctx.globalCompositeOperation = 'source-over';
                this.#ctx.font = "80px Arial";
                this.#ctx.fillStyle = 'black';
                this.#ctx.fillText("GAME OVER", 0, Game.GAME_AREA_HEIGHT/2);

            }

        }

        let game = new Game('canvas', CANVAS_WIDTH, CANVAS_HEIGHT);
        game.startGame();

  
    </script>
</body>

</html>